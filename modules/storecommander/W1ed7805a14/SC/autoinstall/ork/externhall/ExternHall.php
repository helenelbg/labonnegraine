<?php
/*
StoreCommander
*/
 class ExternHall { const EXTRA_PARAMS_KEY = "\145\x78\164\162\x61\x5f\x70\x61\x72\x61\155\x73"; private $allowedScIp; private $classNameByAction = array("\x75\163\141\x67\x65" => "\105\x78\x74\145\162\x6e\x48\141\x6c\154\125\x73\141\x67\x65", "\141\165\x74\x6f\165\x70\x64\x61\164\x65" => "\105\x78\164\x65\162\x6e\x48\x61\x6c\154\x41\x75\x74\157\x55\160\144\x61\164\x65"); private $actionNeedTrendsCheckup = array("\165\x73\141\147\x65"); private $allowedProcess; private $allowedAction; private $extraParamsArray; private $process; private $action; private $distantIpReceived; private $extraParams; private $token; private $paramServer; public function __construct($server) { goto DsFXg; sCQq0: $this->paramServer = $server; goto YoQAf; XfhOV: $this->allowedAction = array_keys($this->classNameByAction); goto sCQq0; DsFXg: $this->allowedScIp = gethostbyname("\x73\x74\x6f\x72\145\143\x6f\155\155\141\x6e\144\x65\162\56\143\x6f\155"); goto XfhOV; YoQAf: } public function setPropertiesFromServer() { goto IjK0c; hnjcH: $this->action = array_key_exists("\110\124\x54\120\137\130\137\x53\x43\x5f\x41\103\x54\111\x4f\x4e", $this->paramServer) ? $this->paramServer["\110\x54\124\120\x5f\130\137\x53\103\137\101\103\x54\111\117\116"] : null; goto O7k7R; IjK0c: $this->token = array_key_exists("\x48\124\124\x50\137\130\137\123\x43\137\x54\117\x4b\x45\x4e", $this->paramServer) ? (string) $this->paramServer["\x48\x54\124\120\137\130\137\123\103\x5f\124\117\113\x45\116"] : null; goto hnjcH; O7k7R: $this->extraParams = json_decode(file_get_contents("\x70\150\160\x3a\x2f\x2f\151\156\x70\x75\x74"), true); goto ai1Sc; ai1Sc: $this->distantIpReceived = array_key_exists("\110\x54\124\x50\137\x58\x5f\x53\103\x5f\111\120\137\122\105\106\105\122\105\x52", $this->paramServer) ? (string) $this->paramServer["\x48\x54\124\x50\x5f\x58\x5f\123\103\x5f\x49\x50\x5f\122\105\106\105\x52\x45\x52"] : null; goto lMB2t; lMB2t: } public function isValidEntrance() { goto e4Wv4; e4Wv4: if (!(!$this->isWhiteListedIp() || !$this->isAllowedAction() || $this->extraParams !== null && !$this->isValidExtraParams())) { goto s0AZX; } goto f63Uo; GgboI: s0AZX: goto L1Ddn; f63Uo: return false; goto GgboI; L1Ddn: return true; goto FN0fk; FN0fk: } protected function setExtraParams() { goto Vsgoc; dhTh4: return array(); goto ulITI; ulITI: LnF1k: goto ILIXd; ILIXd: $this->extraParamsArray = $this->extraParams[ExternHall::EXTRA_PARAMS_KEY]; goto Zpz0d; Vsgoc: if (is_array($this->extraParams)) { goto LnF1k; } goto dhTh4; Zpz0d: } public function isValidToken() { $localToken = (string) hash("\163\150\x61\x35\x31\62", Configuration::get("\123\x43\x5f\114\111\x43\x45\116\x53\x45\x5f\x4b\x45\131", false, 0, 0)); return $this->token === $localToken; } public function allowSendingData() { goto m5ZUB; a8OvX: if (!(!empty($settings) && array_key_exists("\x41\x50\x50\137\124\x52\105\x4e\x44\123", $settings) && (int) $settings["\101\120\120\x5f\124\122\105\x4e\x44\x53"] != 1)) { goto OUiYI; } goto COvXa; COvXa: return false; goto a56oz; GrD7L: $settings = json_decode(Configuration::get("\x53\x43\x5f\123\x45\124\124\111\x4e\x47\x53", null, 0, 0), true); goto a8OvX; m5ZUB: if (in_array($this->action, $this->actionNeedTrendsCheckup)) { goto GLduM; } goto b7SLN; Rsy3f: GLduM: goto GrD7L; a56oz: OUiYI: goto IKHX0; IKHX0: return true; goto lTgi3; b7SLN: return true; goto Rsy3f; lTgi3: } public function doProcess() { goto UpfOT; nnV7G: $this->setExtraParams(); goto KHEU1; tCuTv: if (file_exists(_PS_MODULE_DIR_ . $currentScFolderName . "\57" . $scFolderHash)) { goto vId62; } goto EerrH; eq17s: $CRON = true; goto j00_J; Pyxzt: if (!empty($scFolderHash)) { goto SPEeB; } goto jhvng; KHEU1: $scFolderHash = Configuration::get("\123\x43\137\106\117\x4c\x44\x45\122\x5f\110\101\x53\110", null, 0, 0); goto Pyxzt; UpfOT: global $default_settings, $local_settings, $custom_settings; goto nnV7G; EerrH: return; goto tbNx1; vyyaX: SPEeB: goto eq17s; j8yre: $currentScFolderName = basename(realpath("\x2e\56\57\56\x2e\x2f")); goto tCuTv; j00_J: $_POST = array("\141\143\x74\151\157\156" => "\155\x61\x70\160\x69\156\x67\137\x70\x72\157\143\145\x73\163", "\141\152\x61\170" => 1); goto j8yre; Pknpl: $actionObject = new $actionClassName($this->extraParamsArray); goto u985l; u985l: $actionObject->doProcess(); goto V2c0D; stT9u: require_once _PS_MODULE_DIR_ . $currentScFolderName . "\x2f" . $scFolderHash . "\x2f\x53\x43\57\151\x6e\151\164\137\163\x63\56\160\x68\160"; goto wT0db; tbNx1: vId62: goto stT9u; wT0db: $actionClassName = (string) $this->classNameByAction[$this->action]; goto Pknpl; jhvng: $scFolderHash = Configuration::get("\123\103\x5f\106\117\x4c\104\x45\x52\x5f\110\x41\123\110"); goto vyyaX; V2c0D: } public function exitPage($code) { goto qjgWb; qjgWb: switch ($code) { case 403: header("\110\x54\x54\x50\x2f\61\56\61\40\x34\x30\x33\x20\x46\x6f\162\142\x69\x64\144\x65\x6e"); goto eKkok; default: header("\110\x54\x54\x50\57\61\56\x31\x20\62\60\60\40\x4f\113"); } goto xa0Hw; Eft2a: die; goto dsHCg; xa0Hw: XT9ls: goto u616k; u616k: eKkok: goto Eft2a; dsHCg: } private function isWhiteListedIp() { return $this->allowedScIp == $this->distantIpReceived; } private function isAllowedAction() { return in_array($this->action, $this->allowedAction); } private function isValidExtraParams() { return is_array($this->extraParams) && array_key_exists(ExternHall::EXTRA_PARAMS_KEY, $this->extraParams); } }
